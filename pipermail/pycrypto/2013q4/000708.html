<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [pycrypto] Crypto.Random crashes due to unaligned access
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:pycrypto%40lists.dlitz.net?Subject=Re%3A%20%5Bpycrypto%5D%20Crypto.Random%20crashes%20due%20to%20unaligned%20access&In-Reply-To=%3CC75A84166056C94F84D238A44AF9F6AD0375818A%40AUSX10MPC102.AMER.DELL.COM%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000707.html">
   <LINK REL="Next"  HREF="000709.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[pycrypto] Crypto.Random crashes due to unaligned access</H1>
    <B>Paul_Koning at Dell.com</B> 
    <A HREF="mailto:pycrypto%40lists.dlitz.net?Subject=Re%3A%20%5Bpycrypto%5D%20Crypto.Random%20crashes%20due%20to%20unaligned%20access&In-Reply-To=%3CC75A84166056C94F84D238A44AF9F6AD0375818A%40AUSX10MPC102.AMER.DELL.COM%3E"
       TITLE="[pycrypto] Crypto.Random crashes due to unaligned access">Paul_Koning at Dell.com
       </A><BR>
    <I>Thu Oct 24 13:16:42 PDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="000707.html">[pycrypto] Crypto.Random crashes due to unaligned access
</A></li>
        <LI>Next message: <A HREF="000709.html">[pycrypto] Crypto.Random crashes due to unaligned access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#708">[ date ]</a>
              <a href="thread.html#708">[ thread ]</a>
              <a href="subject.html#708">[ subject ]</a>
              <a href="author.html#708">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Oct 24, 2013, at 4:10 PM, Andrew Cooper &lt;<A HREF="http://lists.dlitz.net/cgi-bin/mailman/listinfo/pycrypto">andyhhp at gmail.com</A>&gt; wrote:

&gt;<i> 
</I>&gt;<i> On 24/10/2013 17:59, Dwayne Litzenberger wrote:
</I>&gt;&gt;<i> Hi Greg!
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> What version/build of GCC is this?  Does &quot;setup.py test&quot; crash for you as well?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I'd rather figure out how to fix the problem than to start making copies of the key.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Greg Price &lt;<A HREF="http://lists.dlitz.net/cgi-bin/mailman/listinfo/pycrypto">gnprice at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> I get the following crash in a PyCrypto built from the current master,
</I>&gt;&gt;&gt;<i> af058ee (aka v2.6.1-136-gaf058ee):
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> import Crypto.Random
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Crypto.Random.new().read(1)
</I>&gt;&gt;&gt;<i> Segmentation fault (core dumped)
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> This is on i686.  I compiled with GCC 4.6.3 (or &quot;Ubuntu/Linaro
</I>&gt;&gt;&gt;<i> 4.6.3-1ubuntu5&quot;.)
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> GDB shows the crash is here:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Program received signal SIGSEGV, Segmentation fault.
</I>&gt;&gt;&gt;<i> aes_key_setup_enc (keylen=32, cipherKey=
</I>&gt;&gt;&gt;<i> 0x841b1bc
</I>&gt;&gt;&gt;<i> &quot;L\fB2\244\225\235\206^\242\305\305b\201\200\335&#326;{d\240\343\262;m\361\243\276u~\337&amp;&quot;,
</I>&gt;&gt;&gt;<i> rk=
</I>&gt;&gt;&gt;<i>   0x84900a8) at src/AESNI.c:122
</I>&gt;&gt;&gt;<i> 122            rk[0] = _mm_loadu_si128((const __m128i*) cipherKey);
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> at which the instruction is
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> (gdb) x/i $pc
</I>&gt;&gt;&gt;<i> =&gt; 0xb78f2600 &lt;ALGnew+2160&gt;: movdqa %xmm0,0x40(%esi)
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> This is an aligned store.  The documentation of MOVDQA says it should
</I>&gt;&gt;&gt;<i> be 16-byte aligned.  The value of rk (aka %esi + 0x40) is only 8-byte
</I>&gt;&gt;&gt;<i> aligned:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> (gdb) p rk
</I>&gt;&gt;&gt;<i> $5 = (__m128i *) 0x84900a8
</I>&gt;&gt;&gt;<i> (gdb) p/x $esi
</I>&gt;&gt;&gt;<i> $9 = 0x8490068
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> It's not clear to me why GCC generated an aligned instruction here --
</I>&gt;&gt;&gt;<i> in fact, the definition of _mm_loadu_si128 in my emmintrin.h appears
</I>&gt;&gt;&gt;<i> to be
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> extern __inline __m128i __attribute__((__gnu_inline__,
</I>&gt;&gt;&gt;<i> __always_inline__, __artificial__))
</I>&gt;&gt;&gt;<i> _mm_loadu_si128 (__m128i const *__P)
</I>&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;<i> return (__m128i) __builtin_ia32_loaddqu ((char const *)__P);
</I>&gt;&gt;&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://gcc.gnu.org/onlinedocs/gcc/X86-Built_002din-Functions.html">http://gcc.gnu.org/onlinedocs/gcc/X86-Built_002din-Functions.html</A>  would
</I>&gt;<i> suggest that __builtin_ia32_loaddqu is specified to generate movdqu
</I>&gt;<i> rather than movdqa.
</I>&gt;<i> 
</I>&gt;<i> There is certainly nothing I can see in the code which would allow GCC
</I>&gt;<i> to presume that the address is 16  byte aligned.
</I>&gt;<i> 
</I>&gt;<i> ~Andrew
</I>
Indeed.  You can certainly tell GCC about alignment (with the __aligned__ attribute) but that is not specified here.  The fact that the machinery is willing to generate an instruction that requires alignment, without marking the addresses in question as such, is a type error&#8230;

	paul
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000707.html">[pycrypto] Crypto.Random crashes due to unaligned access
</A></li>
	<LI>Next message: <A HREF="000709.html">[pycrypto] Crypto.Random crashes due to unaligned access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#708">[ date ]</a>
              <a href="thread.html#708">[ thread ]</a>
              <a href="subject.html#708">[ subject ]</a>
              <a href="author.html#708">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dlitz.net/cgi-bin/mailman/listinfo/pycrypto">More information about the pycrypto
mailing list</a><br>
</body></html>
